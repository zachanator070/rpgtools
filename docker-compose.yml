services:

  ##########
  # SERVER #
  ##########
  base:
    image: node:16
    working_dir: /opt/rpgtools
    environment:
      - NODE_ENV=development
      - CYPRESS_CACHE_FOLDER=/opt/rpgtools/.cache/Cypress
    volumes:
      - ./:/opt/rpgtools

  server_dev:
    build:
      context: .
      dockerfile: ./packages/server/Dockerfile
      target: base
      args:
        - NODE_ENV=dev
        - CURRENT_UID=${CURRENT_UID}
    command: "npm run --workspace=packages/server dev"
    env_file:
      - .env
    environment:
      - NODE_ENV=development
    volumes:
      - ./packages/server/src:/opt/rpgtools/packages/server/src
      - ./packages/server/tests:/opt/rpgtools/packages/server/tests
      - ./packages/server/dist/server:/opt/rpgtools/packages/server/dist/server
      - ./packages/frontend/dist:/opt/rpgtools/packages/frontend/dist
      # where to store SQLITE db files
      - ./db:/opt/rpgtools/db
      - ./packages/common/src:/opt/rpgtools/packages/common/src
      - ./node_modules:/opt/rpgtools/node_modules
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
      - "9229:9229"
    networks:
      - rpgtools

  server:
    extends:
      service: server_dev
    depends_on:
      - postgres
      - mongodb
      - redis
      - ui-builder

  server-brk:
    extends:
      service: server_dev
    command: "npm run --workspace=packages/server dev-brk"
    depends_on:
      - postgres
      - redis
      - ui-builder

  prod:
    image: zachanator070/rpgtools:latest
    env_file:
      - .env
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    depends_on:
      - mongodb
      - redis
      - postgres
    networks:
      - rpgtools

  ####################
  # Frontend Builder #
  ####################

  ui-builder:
    build:
      context: .
      dockerfile: ./packages/frontend/Dockerfile
      args:
        - CURRENT_UID=${CURRENT_UID}
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV}
    volumes:
      - ./packages/frontend/src:/opt/rpgtools/packages/frontend/src
      - ./packages/common/src:/opt/rpgtools/packages/common/src
      - ./packages/frontend/dist:/opt/rpgtools/packages/frontend/dist
    networks:
      - rpgtools
    command: "npm run --workspace=packages/frontend start-dev"

  ############
  # Database #
  ############

  mongodb:
    image: "mongo:latest"
    environment:
      MONGO_INITDB_DATABASE: "rpgtools"
    volumes:
      - ./dev/mongodb-init:/docker-entrypoint-initdb.d
      - ./dev/mongodb-dump:/mongodb-dump
    ports:
      - "27017:27017"
    networks:
      rpgtools:

  postgres:
    image: "postgres:latest"
    environment:
      POSTGRES_USER: "rpgtools"
      POSTGRES_PASSWORD: "password"
      POSTGRES_DB: "rpgtools"
    volumes:
      - ./dev/postgres-dump:/postgres-dump
    ports:
      - "5432:5432"
    networks:
      rpgtools:

  #########
  # Cache #
  #########

  redis:
    image: "redis:latest"
    ports:
      - "6379:6379"
    networks:
      rpgtools:

networks:
  rpgtools:
